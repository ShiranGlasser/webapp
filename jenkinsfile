pipeline {
    agent {
  label 'docker'
    }
    
    stages {
        stage('Checkout Code') {
            steps {
              checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/ShiranGlasser/webapp.git']])
            }
        }
        stage('build Docker Image') {
            steps {
                sh "docker build -t app-python:${env.BUILD_NUMBER} ."
            }
        }
        stage('Run & Test the Container') {
            steps {
                sh "docker run --name app-python -d -p 8080:50000 app-python:${env.BUILD_NUMBER}"
                sh "sleep 5"
                // sh "curl http://localhost:8888/hello-world-war-1.0.0"
                // sh "docker stop app-java && docker rm app-java "
            }
        }
        stage('Upload to DockerHub') {
            steps {
                withCredentials(bindings:[usernamePassword(credentialsId: 'docker-hub', passwordVariable: 'pass', usernameVariable: 'user')]) {
                
                sh "docker tag app-python:${env.BUILD_NUMBER} shiranglasser10/jenkins-app-python:${env.BUILD_NUMBER}"
                sh "docker login -u $user -p $pass"
                sh "docker push shiranglasser10/jenkins-app-python:${env.BUILD_NUMBER}"
                }
        }
        
    }
}
}
